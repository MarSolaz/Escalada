<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Zenith Ascent</title>
<style>
body { margin: 0; overflow: hidden; background: #f0e7df; font-family: 'Segoe UI', sans-serif; }
canvas { display: block; touch-action: none; margin: 0 auto; }

#startOverlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: #f0e7df;
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    z-index: 100;
}
#startBtn {
    padding: 15px 40px; font-size: 24px; font-weight: 200; letter-spacing: 4px;
    color: #3c281e; border: 1px solid #3c281e; background: transparent;
    cursor: pointer; transition: all 0.3s;
}
#startBtn:hover { background: #3c281e; color: #f0e7df; }

#ui { position: absolute; top: 40px; right: 40px; text-align: right; color: rgba(60,40,30,0.7); pointer-events: none; z-index: 10; }
#altitud { font-size: 32px; font-weight: 200; }
.timer-wrap { position: absolute; bottom: 40px; left: 50%; transform: translateX(-50%); width: 200px; height: 6px; background: rgba(0,0,0,0.05); border-radius: 10px; }
#timer-fill { height: 100%; width: 0%; background: #b35a3c; border-radius: 10px; }
#msg { position: absolute; top: 100px; left: 50%; transform: translateX(-50%); font-size: 28px; font-weight: 600; color: #fffa; pointer-events: none; text-shadow: 0 0 10px rgba(0,0,0,0.4); transition: opacity 0.5s; z-index: 20; }
#musicIcon { position: absolute; top: 40px; left: 40px; width: 40px; height: 40px; background: rgba(255,255,255,0.3); border-radius: 50%; display:flex;align-items:center;justify-content:center;cursor:pointer; z-index: 10; }
#musicIcon::after { content: '♫'; font-size: 20px; color:#3c281e; }
</style>
</head>
<body>

<div id="startOverlay"><button id="startBtn">A ESCALAR</button></div>

<div id="ui"><div id="altitud">0m</div></div>
<div class="timer-wrap"><div id="timer-fill"></div></div>
<div id="msg"></div>
<div id="musicIcon"></div>
<audio id="bgMusic" src="andino.mp3" loop></audio>
<canvas id="gameCanvas"></canvas>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const timerFill = document.getElementById('timer-fill');
const msgDiv = document.getElementById('msg');
const bgMusic = document.getElementById('bgMusic');
const musicIcon = document.getElementById('musicIcon');
const startOverlay = document.getElementById('startOverlay');
const startBtn = document.getElementById('startBtn');

let gameStarted = false;

startBtn.addEventListener('click', () => {
    startOverlay.style.display = 'none';
    bgMusic.play().catch(e => {});
    gameStarted = true;
    lastJumpTime = Date.now();
    lastBirdSpawn = Date.now();
    requestAnimationFrame(gameLoop);
});

musicIcon.addEventListener('click', () => {
    if(bgMusic.paused){ bgMusic.play(); musicIcon.style.background='rgba(255,255,255,0.3)'; }
    else { bgMusic.pause(); musicIcon.style.background='rgba(255,0,0,0.3)'; }
});

const IMPULSO = 14.5, GRAVEDAD = 0.38;

function resize(){ 
    canvas.height = window.innerHeight; 
    canvas.width = Math.min(window.innerWidth, window.innerHeight*(9/16)); 
}
window.addEventListener('resize', resize);
resize();

const PALETTE = [
    {sky:'#f0e7df', rockTop:'#b54c2b', rockMid:'#c86a48', rockBase:'#d9956f'},
    {sky:'#f7d9d3', rockTop:'#b54c2b', rockMid:'#c86a48', rockBase:'#d9956f'},
    {sky:'#f5e0d1', rockTop:'#b54c2b', rockMid:'#c86a48', rockBase:'#d9956f'},
    {sky:'#f0d9e0', rockTop:'#b54c2b', rockMid:'#c86a48', rockBase:'#d9956f'}
];

let cameraY=0, timeCycle=0, lastJumpTime=Date.now(), progressCount=0, ledgesTouched=new Set();
let checkpoints=[{x:100,y:580}];
let player={x:100,y:580,vx:0,vy:0,anchorX:100,anchorY:580,state:'hanging',ropeLen:60,angle:-Math.PI/2};
let ledges=[], rockPoints=[], clouds=[], birds=[];
let lastBirdSpawn = Date.now();

// Inicializar nubes
for(let i=0;i<6;i++){ 
    clouds.push({x:Math.random()*canvas.width, y:Math.random()*canvas.height, speed:0.2+Math.random()*0.1, size:10+Math.random()*10}); 
}

function generateChunk(startY, blocks){
    for(let i=0;i<blocks;i++){
        let y = startY-(i*35);
        rockPoints.push({y:y, x:180+Math.sin(y/80)*30+Math.random()*20});
        if(y<500 && i%4===0){
            const p=rockPoints[rockPoints.length-1];
            let isFake = (ledges.length < 8) ? false : Math.random()>0.85;
            ledges.push({x:p.x-20, y:y, w:55, fake:isFake, id:Math.random(), broken:false});
            ledges.push({x:p.x-90, y:y-70, w:50, fake:false, id:Math.random(), broken:false});
        }
    }
}
generateChunk(650,60);

window.addEventListener('mousemove', e => {
    let rect=canvas.getBoundingClientRect();
    player.angle=Math.atan2((e.clientY-rect.top)-(player.y-cameraY),(e.clientX-rect.left)-player.x);
});

function lerpColor(a,b,t){
    const parse=c=>({r:parseInt(c.slice(1,3),16),g:parseInt(c.slice(3,5),16),b:parseInt(c.slice(5,7),16)});
    const c1=parse(a),c2=parse(b);
    return `rgb(${Math.round(c1.r+(c2.r-c1.r)*t)},${Math.round(c1.g+(c2.g-c1.g)*t)},${Math.round(c1.b+(c2.b-c1.b)*t)})`;
}

function showMsg(text){
    msgDiv.innerText=text; msgDiv.style.opacity=1;
    setTimeout(()=>{ msgDiv.style.opacity=0; },1200);
}

function update(){
    if(!gameStarted) return;
    timeCycle += 0.0003;
    let now=Date.now(), elapsed=now-lastJumpTime;

    if(elapsed>3000 && player.state==='hanging'){
        player.state='jumping';
        player.vx=Math.cos(player.angle)*IMPULSO;
        player.vy=Math.sin(player.angle)*IMPULSO;
        lastJumpTime=now;
    }
    timerFill.style.width=Math.min(100,(elapsed/3000*100))+"%";

    if(player.state==='hanging'){
        let osc=Math.sin(now*0.0015)*0.2;
        player.x=player.anchorX+Math.sin(osc)*player.ropeLen;
        player.y=player.anchorY+Math.cos(osc)*player.ropeLen;
    } else {
        player.vy+=GRAVEDAD;
        player.x+=player.vx; player.y+=player.vy;
        ledges.forEach(l=>{
            if(!l.broken && player.vy>0 && player.x>l.x-10 && player.x<l.x+l.w+10 && Math.abs(player.y-l.y)<20){
                if(l.fake){ l.broken=true; player.state='falling'; showMsg('¡Paso en falso!'); }
                else{
                    player.state='hanging'; player.anchorX=player.x; player.anchorY=l.y;
                    player.vx=0; player.vy=0;
                    if(!ledgesTouched.has(l.id)){
                        ledgesTouched.add(l.id); progressCount++;
                        if(progressCount>=3){ checkpoints.push({x:player.x,y:l.y}); progressCount=0; showMsg('¡Puesto seguro!'); }
                    }
                }
            }
        });
    }

    let safe=checkpoints[checkpoints.length-1];
    if(player.y>safe.y+600){
        player.state='hanging'; player.anchorX=safe.x; player.anchorY=safe.y;
        player.x=safe.x; player.y=safe.y+player.ropeLen;
        player.vx=0; player.vy=0; lastJumpTime=now;
    }

    cameraY+=(player.y-canvas.height/1.6-cameraY)*0.05;
    document.getElementById('altitud').innerText=`${Math.max(0,Math.floor(-player.y/10+58))}m`;
    if(rockPoints[rockPoints.length-1].y > cameraY-1500) generateChunk(rockPoints[rockPoints.length-1].y-35,40);

    // Mover Nubes
    clouds.forEach(c => { c.x += c.speed; if(c.x > canvas.width + 50) c.x = -50; });

    // Aves
    if(now - lastBirdSpawn > 5000){ 
        birds.push({x: -30, y: cameraY + (Math.random() * canvas.height), speed: 0.8 + Math.random() * 0.7, wing: 0}); 
        lastBirdSpawn = now; 
    }
    birds.forEach((b,i)=>{ b.x += b.speed; b.wing = Math.sin(now * 0.01) * 5; if(b.x > canvas.width + 40) birds.splice(i,1); });
}

function draw(){
    let stateIdx=Math.floor(timeCycle%PALETTE.length);
    let nextIdx=(stateIdx+1)%PALETTE.length;
    let t=timeCycle%1;
    let curSky=lerpColor(PALETTE[stateIdx].sky, PALETTE[nextIdx].sky, t);

    // Dibujar Cielo
    ctx.fillStyle=curSky;
    ctx.fillRect(0,0,canvas.width,canvas.height);

    // Dibujar Nubes
    clouds.forEach(c=>{
        ctx.fillStyle='rgba(255,255,255,0.6)';
        ctx.beginPath();
        ctx.arc(c.x, c.y, c.size*1.2, 0, Math.PI*2);
        ctx.arc(c.x+c.size*0.8, c.y+5, c.size, 0, Math.PI*2);
        ctx.arc(c.x-c.size*0.8, c.y+5, c.size*0.9, 0, Math.PI*2);
        ctx.fill();
    });

    ctx.save();
    ctx.translate(0,-cameraY);

    // Montaña
    ctx.beginPath(); ctx.moveTo(0,1000);
    rockPoints.forEach(p=>{ if(p.y>cameraY-800 && p.y<cameraY+canvas.height+800) ctx.lineTo(p.x,p.y); });
    ctx.lineTo(0,cameraY-800);
    let grad=ctx.createLinearGradient(0,cameraY-800,0,cameraY+canvas.height+400);
    grad.addColorStop(0, PALETTE[stateIdx].rockTop); 
    grad.addColorStop(1, PALETTE[stateIdx].rockBase);
    ctx.fillStyle=grad; ctx.fill();

    // Salientes
    ledges.forEach(l=>{
        if(l.y<cameraY-100||l.y>cameraY+canvas.height+100||l.broken) return;
        ctx.fillStyle="rgba(0,0,0,0.1)"; ctx.fillRect(l.x-5,l.y+5,l.w+10,10);
        ctx.fillStyle="rgba(0,0,0,0.2)"; ctx.fillRect(l.x,l.y,l.w,8);
    });

    // Checkpoints y Soga de Vida
    ctx.strokeStyle="rgba(0,0,0,0.15)"; ctx.lineWidth=2; ctx.setLineDash([5,5]);
    ctx.beginPath(); ctx.moveTo(checkpoints[0].x, checkpoints[0].y);
    checkpoints.forEach(cp => ctx.lineTo(cp.x, cp.y));
    ctx.lineTo(player.anchorX, player.anchorY); ctx.stroke(); ctx.setLineDash([]);

    checkpoints.forEach(cp=>{
        ctx.fillStyle="rgba(0,0,0,0.3)";
        ctx.fillRect(cp.x-2, cp.y-10, 4, 12);
        ctx.beginPath(); ctx.arc(cp.x, cp.y-10, 3, 0, Math.PI*2); ctx.fill();
    });

    // Cuerda actual y Guía
    ctx.strokeStyle="rgba(255,255,255,0.6)"; ctx.lineWidth=1.5;
    ctx.beginPath(); ctx.moveTo(player.anchorX,player.anchorY); ctx.lineTo(player.x,player.y-18); ctx.stroke();

    if(player.state==='hanging'){
        ctx.strokeStyle="rgba(255,255,255,0.3)"; ctx.setLineDash([5,10]);
        ctx.beginPath(); ctx.moveTo(player.x, player.y-18);
        ctx.lineTo(player.x+Math.cos(player.angle)*100, player.y-18+Math.sin(player.angle)*100);
        ctx.stroke(); ctx.setLineDash([]);
    }

    // Jugador
    ctx.fillStyle="#3c281e";
    ctx.beginPath(); ctx.arc(player.x,player.y-24,6,0,Math.PI*2); ctx.fill();
    ctx.fillRect(player.x-5,player.y-20,10,18);

    // Aves
    birds.forEach(b=>{
        ctx.strokeStyle='#444'; ctx.lineWidth=1.2;
        ctx.beginPath(); ctx.moveTo(b.x, b.y); ctx.lineTo(b.x+6, b.y-3+b.wing); ctx.lineTo(b.x+12, b.y); ctx.stroke();
    });

    ctx.restore();
}

function gameLoop(){
    if(!gameStarted) return;
    update();
    draw();
    requestAnimationFrame(gameLoop);
}
// Dibujar escena inicial
draw();
</script>
</body>
</html>